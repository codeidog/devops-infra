name: 'Terraform Deploy'

on:
  push:
    branches:
      - main
    paths:
      - '**/*.tf'
      - '**/*.tfvars'
      - '.github/workflows/*.yml'

env:
  TF_VERSION: '1.13.5'
  AWS_REGION: 'eu-west-1'

jobs:
  get-pr-number:
    name: 'Get PR Number and Run ID'
    runs-on: ubuntu-latest
    outputs:
      pr-number: ${{ steps.set-outputs.outputs.pr-number }}
      run-id: ${{ steps.set-outputs.outputs.run-id }}

    permissions:
      pull-requests: read
      actions: read
      contents: read
    steps:
    - name: Get PR Number & Workflow Run ID
      id: pr-info
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          // Get the commit SHA from the push event
          const commitSha = context.sha;
          console.log(`Looking for PR associated with commit: ${commitSha}`);
          
          // Search for PRs that were merged with this commit
          const { data: pullRequests } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: commitSha,
          });
          
          console.log(`Found ${pullRequests.length} PRs associated with commit`);
          
          // Find the merged PR
          const mergedPR = pullRequests.find(pr => pr.state === 'closed' && pr.merged_at);
          
          if (!mergedPR) {
            console.log('No merged PR found, this might be a direct push to main');
            return { prNumber: '', runId: '' };
          }
          
          const prNumber = mergedPR.number.toString();
          console.log(`Found merged PR: ${prNumber}`);
          
          // Now get the workflow run ID for this PR
          console.log(`Looking for workflow run for PR #${prNumber}`);
          
          // Get workflow runs for the terraform-pr workflow
          const { data: workflowRuns } = await github.rest.actions.listWorkflowRuns({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'terraform-pr.yml',
            head_sha: commitSha,
            status: 'success',
            per_page: 100
          });
          
          console.log(`Found ${workflowRuns.workflow_runs.length} successful workflow runs for commit ${commitSha}`);
          
          // Find the PR run
          const targetRun = workflowRuns.workflow_runs.find(run => 
            run.event === 'pull_request' && run.conclusion === 'success'
          );
          
          if (targetRun) {
            console.log(`Found workflow run ${targetRun.id} for PR #${prNumber}`);
            return { prNumber, runId: targetRun.id.toString() };
          }
          
          
          console.log(`No successful workflow run found for PR #${prNumber}`);
          return { prNumber, runId: '' };

    - name: Set Job Outputs
      id: set-outputs
      run: |
        PR_INFO='${{ steps.pr-info.outputs.result }}'
        echo "Raw output: $PR_INFO"
        
        # Parse JSON output
        PR_NUMBER=$(echo "$PR_INFO" | jq -r '.prNumber // ""')
        RUN_ID=$(echo "$PR_INFO" | jq -r '.runId // ""')
        
        echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
        echo "run-id=$RUN_ID" >> $GITHUB_OUTPUT
        
        echo "Parsed PR Number: $PR_NUMBER"
        echo "Parsed Run ID: $RUN_ID"

  terraform-apply:
    name: 'Terraform Apply'
    runs-on: ubuntu-latest
    needs: get-pr-number
    if: needs.get-pr-number.outputs.pr-number != ''
    defaults:
      run:
        working-directory: ./

    permissions:
      statuses: write
      contents: read
      id-token: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Download Plan Artifact
      uses: actions/download-artifact@v5
      id: download-artifact
      continue-on-error: true
      if: needs.get-pr-number.outputs.run-id != '' && needs.get-pr-number.outputs.pr-number != ''
      with:
        name: terraform-plan-${{ needs.get-pr-number.outputs.pr-number }}
        run-id: ${{ needs.get-pr-number.outputs.run-id }}
        path: ./

    - name: Terraform Init
      id: init
      run: terraform init

    - name: Verify Plan File
      id: verify
      run: |
        if [ -f "tfplan-${{ needs.get-pr-number.outputs.pr-number }}" ]; then
          echo "Plan file found"
          echo "plan-exists=true" >> $GITHUB_OUTPUT
        else
          echo "Plan file not found, generating new plan"
          echo "plan-exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Generate Fresh Plan (Fallback)
      id: fresh-plan
      if: steps.verify.outputs.plan-exists == 'false'
      run: |
        echo "Generating fresh plan as artifact not found"
        terraform plan -no-color -out=tfplan-fresh
        terraform show -no-color tfplan-fresh > plan_output.txt

    - name: Terraform Apply with Artifact
      id: apply-artifact
      if: steps.verify.outputs.plan-exists == 'true'
      run: |
        echo "Applying plan from artifact"
        terraform apply -auto-approve tfplan-${{ needs.get-pr-number.outputs.pr-number }}

    - name: Terraform Apply Fresh Plan
      id: apply-fresh
      if: steps.verify.outputs.plan-exists == 'false'
      run: |
        echo "Applying fresh plan"
        terraform apply -auto-approve tfplan-fresh

    - name: Generate Deployment Summary
      id: summary
      if: steps.apply-artifact.outcome == 'success' || steps.apply-fresh.outcome == 'success'
      run: |
        echo "## Deployment Summary" > deployment_summary.md
        echo "âœ… **Deployment Status**: SUCCESS" >> deployment_summary.md
        echo "ğŸ• **Deployment Time**: $(date)" >> deployment_summary.md
        echo "ğŸ”— **Commit**: ${{ github.sha }}" >> deployment_summary.md
        echo "ğŸ‘¤ **Deployed by**: ${{ github.actor }}" >> deployment_summary.md
        echo "ğŸ¯ **PR Number**: #${{ needs.get-pr-number.outputs.pr-number }}" >> deployment_summary.md
        echo "ğŸ“‹ **Plan Source**: ${{ steps.verify.outputs.plan-exists == 'true' && 'Artifact' || 'Fresh' }}" >> deployment_summary.md
        echo "" >> deployment_summary.md
        echo "### Resources Applied:" >> deployment_summary.md
        
        # Get current state resources
        terraform show -json | jq -r '.values.root_module.resources[]?.address' >> deployment_summary.md 2>/dev/null || echo "Unable to list resources" >> deployment_summary.md

    - name: Comment Deployment Success
      uses: actions/github-script@v7
      if: steps.apply-artifact.outcome == 'success' || steps.apply-fresh.outcome == 'success'
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          
          let summary = 'ğŸš€ **Deployment Successful!**\n\n';
          summary += `âœ… Terraform apply completed successfully\n`;
          summary += `ğŸ• Deployed at: ${new Date().toISOString()}\n`;
          summary += `ğŸ”— Commit: ${context.sha.substring(0, 7)}\n`;
          summary += `ğŸ‘¤ Deployed by: ${context.actor}\n`;
          summary += `ğŸ¯ PR: #${{ needs.get-pr-number.outputs.pr-number }}\n`;
          summary += `ğŸ“‹ Plan source: ${{ steps.verify.outputs.plan-exists == 'true' && 'PR Artifact' || 'Fresh Plan' }}\n\n`;
          
          // Add plan output if available
          try {
            const planOutput = fs.readFileSync('./plan_output.txt', 'utf8');
            if (planOutput && planOutput.length < 50000) {  // Limit size for comment
              summary += `<details><summary>ğŸ“‹ Deployment Details</summary>\n\n\`\`\`terraform\n${planOutput}\n\`\`\`\n\n</details>`;
            }
          } catch (e) {
            console.log('Plan output file not found or too large');
          }

          // Add comment to the commit
          await github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: summary
          });

    - name: Handle Deployment Failure
      uses: actions/github-script@v7
      if: steps.apply-artifact.outcome == 'failure' || steps.apply-fresh.outcome == 'failure'
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const summary = `âŒ **Deployment Failed!**

          ğŸš¨ Terraform apply failed for commit ${context.sha.substring(0, 7)}
          ğŸ‘¤ Attempted by: ${context.actor}
          ğŸ• Failed at: ${new Date().toISOString()}
          ğŸ¯ PR: #${{ needs.get-pr-number.outputs.pr-number }}
          ğŸ“‹ Plan source: ${{ steps.verify.outputs.plan-exists == 'true' && 'PR Artifact' || 'Fresh Plan' }}

          Please check the [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details and fix the issues before retrying.`;

          await github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: summary
          });

    - name: Upload Deployment Logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: terraform-deployment-logs-${{ github.run_number }}
        path: |
          plan_output.txt
          deployment_summary.md
        retention-days: 90

  terraform-apply-direct:
    name: 'Terraform Apply (Direct Push)'
    runs-on: ubuntu-latest
    needs: get-pr-number
    if: needs.get-pr-number.outputs.pr-number == ''
    defaults:
      run:
        working-directory: ./

    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Terraform Init
      id: init
      run: terraform init

    - name: Terraform Plan
      id: plan
      run: |
        terraform plan -no-color -out=tfplan-direct
        terraform show -no-color tfplan-direct > plan_output.txt

    - name: Terraform Apply
      id: apply
      run: terraform apply -auto-approve tfplan-direct

    - name: Comment Direct Push Deployment
      uses: actions/github-script@v7
      if: steps.apply.outcome == 'success'
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const summary = `ğŸš€ **Direct Push Deployment Successful!**

          âœ… Terraform apply completed successfully (direct push to main)
          ğŸ• Deployed at: ${new Date().toISOString()}
          ğŸ”— Commit: ${context.sha.substring(0, 7)}
          ğŸ‘¤ Deployed by: ${context.actor}
          âš ï¸ Note: This was a direct push to main (no PR found)`;

          await github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: summary
          });

    - name: Upload Direct Push Logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: terraform-direct-push-logs-${{ github.run_number }}
        path: |
          plan_output.txt
        retention-days: 90