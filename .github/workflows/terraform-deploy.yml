name: 'Terraform Deploy'

on:
  push:
    branches:
      - main
    paths:
      - '**/*.tf'
      - '**/*.tfvars'
      - '.github/workflows/*.yml'

env:
  TF_VERSION: '1.13.5'
  AWS_REGION: 'eu-west-1'

jobs:
  get-pr-info:
    name: 'Get PR Number and Run ID'
    runs-on: ubuntu-latest
    outputs:
      pr-number: ${{ steps.set-outputs.outputs.pr-number }}
      run-id: ${{ steps.set-outputs.outputs.run-id }}

    permissions:
      pull-requests: read
      actions: read
      contents: read
    steps:
    - name: Get PR Number & Workflow Run ID
      id: pr-info
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          // Get the commit SHA from the push event
          const commitSha = context.sha;
          console.log(`Looking for PR associated with commit: ${commitSha}`);
          
          // Search for PRs that were merged with this commit
          const { data: pullRequests } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: commitSha,
          });
          
          console.log(`Found ${pullRequests.length} PRs associated with commit`);
          
          // Find the merged PR
          const mergedPR = pullRequests.find(pr => pr.state === 'closed' && pr.merged_at);
          
          if (!mergedPR) {
            console.log('No merged PR found, this might be a direct push to main');
            return { prNumber: '', runId: '' };
          }
          
          const prNumber = mergedPR.number.toString();
          console.log(`Found merged PR: ${prNumber}`);
          console.log(`PR Merge Commit SHA: ${mergedPR.merge_commit_sha}`);
          console.log(`PR Head SHA: ${mergedPR.head.sha}`);
          
          // Now get the workflow run ID for this PR
          console.log(`Looking for workflow run for PR #${prNumber}`);
          
          // Get workflow runs for the terraform-pr workflow
          // Note: Don't filter by head_sha since squash merges create new commit SHAs
          const { data: workflowRuns } = await github.rest.actions.listWorkflowRuns({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'terraform-pr.yml',
            event: 'pull_request',
            status: 'success',
            head_sha: mergedPR.head.sha,
            per_page: 50
          });
          
          console.log(`Found ${workflowRuns.workflow_runs.length} successful workflow runs for commit ${commitSha}`);
          
          // Find the PR run
          const targetRun = workflowRuns.workflow_runs.find(run => 
            run.event === 'pull_request' && run.conclusion === 'success'
          );
          
          if (targetRun) {
            console.log(`Found workflow run ${targetRun.id} for PR #${prNumber}`);
            return { prNumber, runId: targetRun.id.toString() };
          }
          
          
          console.log(`No successful workflow run found for PR #${prNumber}`);
          return { prNumber, runId: '' };

    - name: Set Job Outputs
      id: set-outputs
      run: |
        PR_INFO='${{ steps.pr-info.outputs.result }}'
        echo "Raw output: $PR_INFO"
        
        # Parse JSON output
        PR_NUMBER=$(echo "$PR_INFO" | jq -r '.prNumber // ""')
        RUN_ID=$(echo "$PR_INFO" | jq -r '.runId // ""')
        
        echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
        echo "run-id=$RUN_ID" >> $GITHUB_OUTPUT
        
        echo "Parsed PR Number: $PR_NUMBER"
        echo "Parsed Run ID: $RUN_ID"

  terraform-apply:
    name: 'Terraform Apply'
    runs-on: ubuntu-latest
    needs: get-pr-info
    if: needs.get-pr-info.outputs.pr-number != '' && needs.get-pr-info.outputs.run-id != ''
    defaults:
      run:
        working-directory: ./

    permissions:
      actions: read
      deployments: write
      statuses: write
      contents: read
      id-token: write

    steps:
    - name: Create Deployment & Report status
      id: deployment
      uses: actions/github-script@v7
      with:
        script: |
          const { data: deployment } = await github.rest.repos.createDeployment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: context.sha,
            environment: 'production',
            description: 'Terraform infrastructure deployment',
            auto_merge: false,
            required_contexts: []
          });
          console.log(`Created deployment: ${deployment.id}`);
          
          // Set initial deployment status to 'in_progress'
          await github.rest.repos.createDeploymentStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            deployment_id: deployment.id,
            state: 'in_progress',
            description: 'Terraform deployment in progress...'
          });

          return deployment.id;

    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Download Plan Artifact
      uses: actions/download-artifact@v5
      id: download-artifact
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        name: terraform-plan-${{ needs.get-pr-info.outputs.pr-number }}
        run-id: ${{ needs.get-pr-info.outputs.run-id }}
        path: ./
    
    - name: Verify Plan File
      id: verify
      run: |
        if [ -f "tfplan-${{ needs.get-pr-info.outputs.pr-number }}" ]; then
          echo "Plan file found"
        else
          echo "Plan file not found"
          exit 1
        fi

    - name: Terraform Init
      id: init
      run: terraform init

    - name: Terraform Apply with Artifact
      id: apply-artifact
      if: steps.verify.outputs.plan-exists == 'true'
      run: |
        echo "Applying plan from artifact"
        terraform apply -auto-approve tfplan-${{ needs.get-pr-info.outputs.pr-number }}

    - name: Set Deployment Status - Success
      if: steps.apply-artifact.outcome == 'success'
      uses: actions/github-script@v7
      with:
        script: |

          await github.rest.repos.createDeploymentStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            deployment_id: '${{ steps.deployment.outputs.result }}',
            state: 'success',
            description: `✅ Terraform deployment successful`,
            environment_url: 'https://console.aws.amazon.com/eks/home?region=${{ env.AWS_REGION }}#/clusters'
          });

    - name: Set Deployment Status - Failure
      if: failure()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          await github.rest.repos.createDeploymentStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            deployment_id: '${{ steps.deployment.outputs.result }}',
            state: 'failure',
            description: '❌ Terraform deployment failed',
            log_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
          });
